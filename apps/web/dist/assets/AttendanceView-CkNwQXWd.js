import{r as p,j as a}from"./vendor-react-Cwbq-Nll.js";import{A as N,s as f}from"./index-BLS27RO3.js";import{l as F}from"./TeacherDashboard-DPL4FiLg.js";import"./vendor-BIu-86mi.js";import"./auth.service-BqRRNXX5.js";async function P(m,h){const l=await fetch(`${N}/teacher-attendance-assignments/teacher/${h}`,{headers:{Authorization:`Bearer ${m}`}});return l.ok?((await l.json()).assignments||[]).map(n=>({id:n.id,class_group_id:n.class_group_id,section_id:n.section_id,subject_id:"",class_groups:n.class_group||{id:"",name:"N/A",description:null},sections:n.section||null,subjects:{id:"",name:"Attendance",code:null}})):[]}async function A(m,h,l){const t=await fetch(`${N}/attendance?class_group_id=${h}&date=${l}`,{headers:{Authorization:`Bearer ${m}`}});if(!t.ok)return{};const n=await t.json(),i={};return n.attendance&&n.attendance.forEach(y=>{i[y.student_id]=y.status||"present"}),i}async function R(m,h){const l=await fetch(`${N}/attendance/bulk`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${m}`},body:JSON.stringify({attendance:h})});if(!l.ok){const t=await l.json();throw new Error(t.error||"Failed to save attendance")}}function J({profile:m}){var _,k;const[h,l]=p.useState([]),[t,n]=p.useState(null),[i,y]=p.useState([]),[g,S]=p.useState(new Date().toISOString().split("T")[0]),[v,b]=p.useState({}),[E,w]=p.useState(!0);p.useEffect(()=>{C()},[]),p.useEffect(()=>{(async()=>{var s;if(!(!t||!g||i.length===0))try{const r=(s=(await f.auth.getSession()).data.session)==null?void 0:s.access_token;if(!r)return;const o=await A(r,t.class_group_id,g),d={};(i??[]).forEach(c=>{c!=null&&c.id&&o[c.id]&&o[c.id]!=="present"&&(d[c.id]=o[c.id])}),b(d)}catch(r){console.error("Error loading attendance records:",r)}})()},[g,t,i]);const C=async()=>{var e,s,r;try{w(!0);const o=await f.auth.getSession(),d=(e=o.data.session)==null?void 0:e.access_token,c=(r=(s=o.data.session)==null?void 0:s.user)==null?void 0:r.id;if(!d||!c)return;const x=await P(d,c);l(x??[])}catch(o){console.error("Error loading assignments:",o)}finally{w(!1)}},$=async e=>{var s;try{const r=(s=(await f.auth.getSession()).data.session)==null?void 0:s.access_token;if(!r)return;const o=await F(r,e.class_group_id,e.section_id||void 0);y(o??[]),n(e);const d=await A(r,e.class_group_id,g),c={};(o??[]).forEach(x=>{x!=null&&x.id&&d[x.id]&&d[x.id]!=="present"&&(c[x.id]=d[x.id])}),b(c)}catch(r){console.error("Error loading students:",r)}},j=e=>v[e]??"present",u=(e,s)=>{b(r=>{if(s==="present"){const o={...r};return delete o[e],o}return{...r,[e]:s}})},M=()=>{b({})},B=()=>{const e={};(i??[]).forEach(s=>{s!=null&&s.id&&(e[s.id]="absent")}),b(e)},D=async()=>{var e;if(t)try{const s=(e=(await f.auth.getSession()).data.session)==null?void 0:e.access_token;if(!s)throw new Error("No authentication token");const r=(i??[]).map(o=>({student_id:o.id,class_group_id:t.class_group_id,date:g,status:v[o.id]??"present",school_id:m.school_id}));await R(s,r),alert("Attendance saved successfully!")}catch(s){alert(s.message||"Failed to save attendance")}};return E?a.jsx("div",{className:"text-center py-8",children:"Loading..."}):a.jsxs("div",{children:[a.jsx("h2",{className:"text-3xl font-bold mb-6",children:"Mark Attendance"}),a.jsx("p",{className:"text-sm text-gray-600 mb-4",children:"Select a class you are assigned to mark attendance for. Only classes assigned by the principal are shown."}),!t&&a.jsxs("div",{className:"bg-white rounded-lg shadow-md p-6 mb-6",children:[a.jsx("p",{className:"text-gray-600 mb-4",children:"Select a class to mark attendance:"}),h.length===0?a.jsxs("div",{className:"text-center py-8 text-gray-500",children:[a.jsx("p",{className:"mb-2",children:"No attendance classes assigned."}),a.jsx("p",{className:"text-sm",children:"Please contact the principal to assign you to mark attendance for classes."})]}):a.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:(h??[]).filter(Boolean).map(e=>{var s;return a.jsxs("button",{onClick:()=>e&&$(e),className:"bg-teal-50 hover:bg-teal-100 p-4 rounded-lg text-left transition border-2 border-teal-200",children:[a.jsx("div",{className:"font-semibold text-teal-800",children:((s=e==null?void 0:e.class_groups)==null?void 0:s.name)??"N/A"}),(e==null?void 0:e.sections)&&a.jsxs("div",{className:"text-sm text-gray-600",children:["Section: ",e.sections.name]}),!(e!=null&&e.sections)&&a.jsx("div",{className:"text-sm text-gray-500",children:"All Sections"}),a.jsx("div",{className:"text-teal-600 mt-2",children:"ðŸ“… Attendance Class"})]},(e==null?void 0:e.id)||Math.random())})})]}),t&&a.jsxs("div",{className:"bg-white rounded-lg shadow-md p-6",children:[a.jsxs("div",{className:"flex justify-between items-center mb-4",children:[a.jsxs("div",{children:[a.jsxs("h3",{className:"text-xl font-bold",children:[((_=t==null?void 0:t.class_groups)==null?void 0:_.name)??"N/A",(t==null?void 0:t.sections)&&` - ${t.sections.name}`]}),a.jsx("p",{className:"text-gray-600",children:((k=t==null?void 0:t.subjects)==null?void 0:k.name)??"N/A"})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium mb-1",children:"Date"}),a.jsx("input",{type:"date",value:g,onChange:e=>S(e.target.value),className:"px-3 py-2 border rounded-md"})]})]}),i.length===0?a.jsx("div",{className:"text-center py-8 text-gray-500",children:"No students found in this class."}):a.jsxs(a.Fragment,{children:[a.jsxs("div",{className:"flex gap-3 mb-4",children:[a.jsx("button",{onClick:M,className:"bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700",children:"âœ“ Mark All Present"}),a.jsx("button",{onClick:B,className:"bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700",children:"âœ• Mark All Absent"})]}),a.jsx("div",{className:"overflow-x-auto",children:a.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[a.jsx("thead",{className:"bg-gray-50",children:a.jsxs("tr",{children:[a.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"Roll No."}),a.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"Name"}),a.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"Status"})]})}),a.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:(i??[]).filter(Boolean).map(e=>{var s;return a.jsxs("tr",{children:[a.jsx("td",{className:"px-4 py-3 text-sm",children:(e==null?void 0:e.roll_number)??"N/A"}),a.jsx("td",{className:"px-4 py-3 text-sm font-medium",children:((s=e==null?void 0:e.profile)==null?void 0:s.full_name)??"N/A"}),a.jsx("td",{className:"px-4 py-3",children:a.jsxs("div",{className:"flex gap-2",children:[a.jsx("button",{onClick:()=>(e==null?void 0:e.id)&&u(e.id,"present"),className:j((e==null?void 0:e.id)||"")==="present"?"bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700":"bg-gray-200 px-3 py-1 rounded hover:bg-gray-300",children:"âœ“"}),a.jsx("button",{onClick:()=>(e==null?void 0:e.id)&&u(e.id,"absent"),className:j((e==null?void 0:e.id)||"")==="absent"?"bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700":"bg-gray-200 px-3 py-1 rounded hover:bg-gray-300",children:"âœ•"}),a.jsx("button",{onClick:()=>(e==null?void 0:e.id)&&u(e.id,"late"),className:j((e==null?void 0:e.id)||"")==="late"?"bg-yellow-500 text-white px-3 py-1 rounded hover:bg-yellow-600":"bg-gray-200 px-3 py-1 rounded hover:bg-gray-300",children:"â°"})]})})]},(e==null?void 0:e.id)||Math.random())})})]})}),a.jsxs("div",{className:"mt-4 flex gap-3",children:[a.jsx("button",{onClick:D,className:"bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700",children:"Save Attendance"}),a.jsx("button",{onClick:()=>{n(null),y([])},className:"bg-gray-300 text-gray-700 px-6 py-2 rounded-lg hover:bg-gray-400",children:"Back to Classes"})]})]})]})]})}export{J as default};
