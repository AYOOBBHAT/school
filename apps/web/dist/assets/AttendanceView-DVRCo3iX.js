import{A as b,r as x,s as j,j as e}from"./index-BOMOBQPd.js";import{l as E}from"./TeacherDashboard-B9rafxuq.js";import"./auth.service-69BbSp1u.js";async function $(m,i){const o=await fetch(`${b}/teacher-attendance-assignments/teacher/${i}`,{headers:{Authorization:`Bearer ${m}`}});return o.ok?((await o.json()).assignments||[]).map(r=>({id:r.id,class_group_id:r.class_group_id,section_id:r.section_id,subject_id:"",class_groups:r.class_group||{id:"",name:"N/A",description:null},sections:r.section||null,subjects:{id:"",name:"Attendance",code:null}})):[]}async function v(m,i,o){const s=await fetch(`${b}/attendance?class_group_id=${i}&date=${o}`,{headers:{Authorization:`Bearer ${m}`}});if(!s.ok)return{};const r=await s.json(),l={};return r.attendance&&r.attendance.forEach(p=>{l[p.student_id]=p.status||"present"}),l}async function C(m,i){const o=await fetch(`${b}/attendance/bulk`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${m}`},body:JSON.stringify({attendance:i})});if(!o.ok){const s=await o.json();throw new Error(s.error||"Failed to save attendance")}}function O({profile:m}){const[i,o]=x.useState([]),[s,r]=x.useState(null),[l,p]=x.useState([]),[h,_]=x.useState(new Date().toISOString().split("T")[0]),[f,y]=x.useState({}),[w,N]=x.useState(!0);x.useEffect(()=>{A()},[]),x.useEffect(()=>{(async()=>{var a;if(!(!s||!h||l.length===0))try{const n=(a=(await j.auth.getSession()).data.session)==null?void 0:a.access_token;if(!n)return;const c=await v(n,s.class_group_id,h),d={};l.forEach(u=>{d[u.id]=c[u.id]||"present"}),y(d)}catch(n){console.error("Error loading attendance records:",n)}})()},[h,s,l]);const A=async()=>{var t,a,n;try{N(!0);const c=await j.auth.getSession(),d=(t=c.data.session)==null?void 0:t.access_token,u=(n=(a=c.data.session)==null?void 0:a.user)==null?void 0:n.id;if(!d||!u)return;const g=await $(d,u);o(g)}catch(c){console.error("Error loading assignments:",c)}finally{N(!1)}},S=async t=>{var a;try{const n=(a=(await j.auth.getSession()).data.session)==null?void 0:a.access_token;if(!n)return;const c=await E(n,t.class_group_id,t.section_id||void 0);p(c),r(t);const d=await v(n,t.class_group_id,h),u={};c.forEach(g=>{u[g.id]=d[g.id]||"present"}),y(u)}catch(n){console.error("Error loading students:",n)}},k=async()=>{var t;if(s)try{const a=(t=(await j.auth.getSession()).data.session)==null?void 0:t.access_token;if(!a)throw new Error("No authentication token");const n=Object.entries(f).map(([c,d])=>({student_id:c,class_group_id:s.class_group_id,date:h,status:d,school_id:m.school_id}));await C(a,n),alert("Attendance saved successfully!")}catch(a){alert(a.message||"Failed to save attendance")}};return w?e.jsx("div",{className:"text-center py-8",children:"Loading..."}):e.jsxs("div",{children:[e.jsx("h2",{className:"text-3xl font-bold mb-6",children:"Mark Attendance"}),e.jsx("p",{className:"text-sm text-gray-600 mb-4",children:"Select a class you are assigned to mark attendance for. Only classes assigned by the principal are shown."}),!s&&e.jsxs("div",{className:"bg-white rounded-lg shadow-md p-6 mb-6",children:[e.jsx("p",{className:"text-gray-600 mb-4",children:"Select a class to mark attendance:"}),i.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx("p",{className:"mb-2",children:"No attendance classes assigned."}),e.jsx("p",{className:"text-sm",children:"Please contact the principal to assign you to mark attendance for classes."})]}):e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:i.map(t=>e.jsxs("button",{onClick:()=>S(t),className:"bg-teal-50 hover:bg-teal-100 p-4 rounded-lg text-left transition border-2 border-teal-200",children:[e.jsx("div",{className:"font-semibold text-teal-800",children:t.class_groups.name}),t.sections&&e.jsxs("div",{className:"text-sm text-gray-600",children:["Section: ",t.sections.name]}),!t.sections&&e.jsx("div",{className:"text-sm text-gray-500",children:"All Sections"}),e.jsx("div",{className:"text-teal-600 mt-2",children:"ðŸ“… Attendance Class"})]},t.id))})]}),s&&e.jsxs("div",{className:"bg-white rounded-lg shadow-md p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsxs("div",{children:[e.jsxs("h3",{className:"text-xl font-bold",children:[s.class_groups.name,s.sections&&` - ${s.sections.name}`]}),e.jsx("p",{className:"text-gray-600",children:s.subjects.name})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Date"}),e.jsx("input",{type:"date",value:h,onChange:t=>_(t.target.value),className:"px-3 py-2 border rounded-md"})]})]}),l.length===0?e.jsx("div",{className:"text-center py-8 text-gray-500",children:"No students found in this class."}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"Roll No."}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"Name"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"Status"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:l.map(t=>e.jsxs("tr",{children:[e.jsx("td",{className:"px-4 py-3 text-sm",children:t.roll_number||"N/A"}),e.jsx("td",{className:"px-4 py-3 text-sm font-medium",children:t.profile.full_name}),e.jsx("td",{className:"px-4 py-3",children:e.jsxs("select",{value:f[t.id]||"present",onChange:a=>{y({...f,[t.id]:a.target.value})},className:"px-3 py-1 border rounded-md text-sm",children:[e.jsx("option",{value:"present",children:"Present"}),e.jsx("option",{value:"absent",children:"Absent"}),e.jsx("option",{value:"late",children:"Late"})]})})]},t.id))})]})}),e.jsxs("div",{className:"mt-4 flex gap-3",children:[e.jsx("button",{onClick:k,className:"bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700",children:"Save Attendance"}),e.jsx("button",{onClick:()=>{r(null),p([])},className:"bg-gray-300 text-gray-700 px-6 py-2 rounded-lg hover:bg-gray-400",children:"Back to Classes"})]})]})]})]})}export{O as default};
