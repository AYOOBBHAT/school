import{r as n,s as H,j as e}from"./index-CN_qW8X5.js";import{b as G,c as J,a as K,d as X}from"./clerk.service-DLvCQljG.js";function Z({student:r,isOpen:y,onClose:g,onPaymentSuccess:I}){const[o,C]=n.useState(null),[c,w]=n.useState([]),[x,E]=n.useState(!1),[u,M]=n.useState([]),[j,R]=n.useState("class-fee"),[_,$]=n.useState(!1),[Y,k]=n.useState({payment_amount:"",payment_date:new Date().toISOString().split("T")[0],payment_mode:"cash",transaction_id:"",cheque_number:"",bank_name:"",notes:""}),[S,P]=n.useState(!1),[A,O]=n.useState(null),[U,W]=n.useState(!1),[T,L]=n.useState(!1),[z,q]=n.useState([]),[Q,D]=n.useState(!1);n.useEffect(()=>{y&&r?t(r.id):(C(null),w([]),M([]),$(!1),L(!1))},[y,r]),n.useEffect(()=>{const s=l=>{l.key==="Escape"&&y&&g()};return window.addEventListener("keydown",s),()=>window.removeEventListener("keydown",s)},[y,g]);const t=async s=>{var l;E(!0);try{const a=(l=(await H.auth.getSession()).data.session)==null?void 0:l.access_token;if(!a)return;try{const d=await G(a,s);d.message&&d.message==="No fee configured for this student"?(C(null),w([])):(C(d.fee_structure),w(d.monthly_ledger||[]))}catch(d){d.message&&d.message.includes("No fee configured")?(C(null),w([])):console.error("Error loading fee data:",d)}}catch(a){console.error("Error loading fee data:",a)}finally{E(!1)}},m=async()=>{var s;if(r){D(!0);try{const l=(s=(await H.auth.getSession()).data.session)==null?void 0:s.access_token;if(!l)return;const a=await J(l,r.id);q(a.payments||[]),L(!0)}catch(l){console.error("Error loading payment history:",l)}finally{D(!1)}}},f=(s,l)=>{const a=new Date,d=a.getFullYear(),v=a.getMonth()+1;return s>d||s===d&&l>v},h=n.useCallback((s,l,a)=>{if(f(l,a)){alert("Cannot select future months for payment. Advance payments require Principal approval.");return}M(d=>d.includes(s)?d.filter(F=>F!==s):[...d,s])},[]),N=n.useMemo(()=>u.length===0?[]:c.flatMap(s=>s.components||[]).filter(s=>u.includes(s.id)),[u,c]),p=n.useMemo(()=>N.reduce((s,l)=>s+l.pending_amount,0),[N]);n.useEffect(()=>{_&&u.length>0&&p>0?k(s=>({...s,payment_amount:p.toFixed(2)})):_&&u.length===0&&k(s=>({...s,payment_amount:""}))},[_,u,p]);const i=s=>{switch(s){case"paid":return"bg-green-100 text-green-800";case"partially-paid":return"bg-yellow-100 text-yellow-800";case"overdue":return"bg-red-100 text-red-800";default:return"bg-gray-100 text-gray-800"}},b=n.useMemo(()=>c.flatMap(s=>s.components||[]).reduce((s,l)=>s+l.pending_amount,0),[c]);return!y||!r?null:e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 bg-black/40 z-40 transition-opacity",onClick:g}),e.jsxs("div",{className:`fixed top-0 right-0 h-full w-[460px] bg-white shadow-2xl z-50 transform transition-transform duration-300 ease-in-out ${y?"translate-x-0":"translate-x-full"} flex flex-col`,children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b bg-gray-50",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("h2",{className:"text-xl font-bold text-gray-900",children:r.name}),e.jsxs("div",{className:"text-sm text-gray-600 mt-1",children:["Roll: ",r.roll_number," | Class: ",r.class]}),b>0&&e.jsx("div",{className:"mt-2",children:e.jsxs("span",{className:"inline-flex items-center px-3 py-1 rounded-full text-sm font-semibold bg-red-100 text-red-800",children:["Total Pending: â‚¹",b.toFixed(2)]})})]}),e.jsx("button",{onClick:g,className:"ml-4 text-gray-500 hover:text-gray-700 text-2xl font-bold leading-none","aria-label":"Close drawer",children:"Ã—"})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-6",children:x?e.jsx("div",{className:"text-center py-8 text-gray-500",children:"Loading fee data..."}):o===null?e.jsxs("div",{className:"bg-yellow-50 border border-yellow-200 rounded-lg p-6 text-center",children:[e.jsx("p",{className:"text-yellow-800 font-semibold text-lg",children:"âš ï¸ No fee configured for this student"}),e.jsx("p",{className:"text-yellow-700 mt-2",children:"Please contact Principal to assign fee structure."})]}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:[e.jsx("h4",{className:"font-semibold mb-3",children:"Assigned Fee Structure"}),e.jsxs("div",{className:"grid grid-cols-1 gap-4 text-sm",children:[(o==null?void 0:o.class_fee)&&e.jsxs("div",{className:"bg-white rounded p-3",children:[e.jsx("div",{className:"font-semibold text-blue-700",children:"Class Fee"}),e.jsxs("div",{children:["â‚¹",o.class_fee.amount.toFixed(2)]}),e.jsx("div",{className:"text-xs text-gray-600",children:o.class_fee.billing_frequency})]}),(o==null?void 0:o.transport_fee)&&e.jsxs("div",{className:"bg-white rounded p-3",children:[e.jsx("div",{className:"font-semibold text-blue-700",children:"Transport Fee"}),e.jsxs("div",{children:["â‚¹",o.transport_fee.amount.toFixed(2)]}),e.jsxs("div",{className:"text-xs text-gray-600",children:[o.transport_fee.route_name," | ",o.transport_fee.billing_frequency]})]}),(o==null?void 0:o.custom_fees)&&o.custom_fees.length>0&&e.jsxs("div",{className:"bg-white rounded p-3",children:[e.jsxs("div",{className:"font-semibold text-blue-700",children:["Custom Fees (",o.custom_fees.length,")"]}),o.custom_fees.map((s,l)=>e.jsxs("div",{className:"text-xs",children:[s.category_name,": â‚¹",s.amount.toFixed(2)," (",s.billing_frequency,")"]},l))]})]})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold mb-3",children:"Monthly Fee Status Ledger"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full bg-white border border-gray-200 rounded-lg text-xs",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase border-b",children:"Month"}),e.jsx("th",{className:"px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase border-b",children:"Fee"}),e.jsx("th",{className:"px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase border-b",children:"Amount"}),e.jsx("th",{className:"px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase border-b",children:"Paid"}),e.jsx("th",{className:"px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase border-b",children:"Pending"}),e.jsx("th",{className:"px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase border-b",children:"Status"}),e.jsx("th",{className:"px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase border-b",children:"âœ“"})]})}),e.jsxs("tbody",{className:"divide-y divide-gray-200",children:[c.map((s,l)=>(s.components||[]).map((a,d)=>{const v=a.status==="overdue"||a.due_date&&new Date(a.due_date)<new Date&&a.status!=="paid",F=f(s.year||0,s.monthNumber||0),B=a.status==="paid"||a.pending_amount===0||F,V=a.status==="paid"?"bg-green-50":v?"bg-red-50":a.status==="partially-paid"?"bg-yellow-50":"bg-white";return e.jsxs("tr",{className:`${V} ${v?"border-l-4 border-red-500":""} ${F?"opacity-60":""}`,children:[e.jsx("td",{className:"px-2 py-2 text-xs font-medium text-gray-900",children:d===0?s.month:""}),e.jsxs("td",{className:"px-2 py-2 text-xs text-gray-700",children:[e.jsx("div",{className:"font-medium",children:a.fee_name}),e.jsx("div",{className:"text-xs text-gray-500 capitalize",children:a.fee_type.replace("-"," ")})]}),e.jsxs("td",{className:"px-2 py-2 text-xs text-gray-700",children:["â‚¹",a.fee_amount.toFixed(2)]}),e.jsx("td",{className:"px-2 py-2 text-xs text-gray-700",children:e.jsxs("span",{className:a.paid_amount>0?"text-green-600 font-semibold":"",children:["â‚¹",a.paid_amount.toFixed(2)]})}),e.jsx("td",{className:"px-2 py-2 text-xs text-gray-700",children:e.jsxs("span",{className:a.pending_amount>0?"text-red-600 font-semibold":"text-gray-500",children:["â‚¹",a.pending_amount.toFixed(2)]})}),e.jsx("td",{className:"px-2 py-2 text-xs",children:e.jsx("span",{className:`px-2 py-1 rounded-full text-xs font-semibold ${i(a.status)}`,children:a.status==="paid"?"ğŸŸ¢":v?"ğŸ”´":a.status==="partially-paid"?"ğŸŸ¡":F?"ğŸ”µ":"âšª"})}),e.jsx("td",{className:"px-2 py-2 text-center",children:e.jsx("input",{type:"checkbox",checked:u.includes(a.id),onChange:()=>h(a.id,s.year||0,s.monthNumber||0),disabled:B,title:F?"Future months require Principal approval":a.status==="paid"?"Already paid":a.pending_amount===0?"No pending amount":"",className:"w-4 h-4 cursor-pointer disabled:cursor-not-allowed"})})]},`${l}-${d}`)})),c.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:7,className:"px-4 py-8 text-center text-gray-500",children:"No fee data available for this student"})})]})]})}),e.jsxs("div",{className:"mt-4 flex flex-wrap gap-4 text-xs",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 bg-green-100 border border-green-300 rounded"}),e.jsx("span",{children:"Paid"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 bg-yellow-100 border border-yellow-300 rounded"}),e.jsx("span",{children:"Partially Paid"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 bg-red-100 border border-red-300 rounded"}),e.jsx("span",{children:"Pending/Overdue"})]})]})]})]})}),e.jsxs("div",{className:"border-t p-4 bg-gray-50 flex gap-2",children:[e.jsx("button",{onClick:m,className:"flex-1 px-4 py-2 rounded-lg font-semibold bg-green-600 text-white hover:bg-green-700 text-sm",children:"View History"}),e.jsxs("button",{onClick:()=>{$(!0),R("class-fee")},disabled:u.length===0,className:`flex-1 px-4 py-2 rounded-lg font-semibold text-sm ${u.length===0?"bg-gray-300 text-gray-500 cursor-not-allowed":"bg-blue-600 text-white hover:bg-blue-700"}`,children:["Collect (",u.length,")"]})]})]})]})}function te(){var L,z,q,Q,D;const[r,y]=n.useState([]),[g,I]=n.useState([]),[o,C]=n.useState(0),[c,w]=n.useState(""),[x,E]=n.useState(""),[u,M]=n.useState([]),[j,R]=n.useState(null),[_,$]=n.useState(!1),[Y,k]=n.useState(!1),[S,P]=n.useState(!1),A=n.useRef(0);n.useEffect(()=>{O()},[]),n.useEffect(()=>{U()},[x]);const O=async()=>{var t;k(!0);try{const m=(t=(await H.auth.getSession()).data.session)==null?void 0:t.access_token;if(!m)return;const h=(await K(m)).classes||[];console.log("[FeeCollection] Loaded classes:",h.map(N=>({id:N.id,name:N.name}))),M(h)}catch(m){console.error("Error loading classes:",m)}finally{k(!1)}},U=async()=>{var m,f,h,N;const t=++A.current;P(!0);try{const p=(m=(await H.auth.getSession()).data.session)==null?void 0:m.access_token;if(!p){P(!1);return}const i=await X(p,x||void 0,1,50);if(t!==A.current){console.log("[FeeCollection] Ignoring stale request result"),P(!1);return}console.log("[FeeCollection] Received data:",{classesCount:((f=i.classes)==null?void 0:f.length)||0,unassignedCount:((h=i.unassigned)==null?void 0:h.length)||0,selectedClass:x,searchQuery:c,total_students:i.total_students,pagination:i.pagination,fullResponse:i});let b=[];if(i.classes&&Array.isArray(i.classes)?(console.log(`[FeeCollection] Processing ${i.classes.length} classes`),i.classes.forEach(s=>{var l;console.log(`[FeeCollection] Processing class: ${s.name} (id: ${s.id}), students: ${((l=s.students)==null?void 0:l.length)||0}`),s.students&&Array.isArray(s.students)?(console.log(`[FeeCollection] Class ${s.name} has ${s.students.length} students`),s.students.forEach(a=>{var v;const d=((v=a.profile)==null?void 0:v.full_name)||"Unknown";console.log(`[FeeCollection] Adding student: ${d} (id: ${a.id}, roll: ${a.roll_number})`),b.push({id:a.id,name:d,roll_number:a.roll_number||"N/A",class:s.name||"N/A",class_group_id:s.id})})):console.warn(`[FeeCollection] Class ${s.name} has no students array or it's not an array:`,s)})):console.warn("[FeeCollection] No classes array in response or it's not an array:",i.classes),!x&&i.unassigned&&Array.isArray(i.unassigned)&&i.unassigned.forEach(s=>{var l;b.push({id:s.id,name:((l=s.profile)==null?void 0:l.full_name)||"Unknown",roll_number:s.roll_number||"N/A",class:"Unassigned",class_group_id:void 0})}),console.log(`[FeeCollection] Extracted ${b.length} students from response`),t===A.current){I(b);const s=i.total_students||((N=i.pagination)==null?void 0:N.total)||0;C(s),console.log(`[FeeCollection] Updated allStudents with ${b.length} students (total from API: ${s})`),c.trim()||(console.log(`[FeeCollection] No search query, setting ${b.length} students immediately`),y(b))}}catch(p){if(console.error("Error loading students:",p),g.length===0&&r.length===0){const i=(p==null?void 0:p.message)||"Failed to load students";console.error("[FeeCollection] API Error:",i)}}finally{t===A.current&&P(!1)}},W=(t,m)=>{if(!m.trim()){console.log(`[FeeCollection] No search query, setting all ${t.length} students`),y(t);return}const f=m.toLowerCase().trim(),h=t.filter(N=>{const p=(N.name||"").toLowerCase(),i=(N.roll_number||"").toLowerCase(),b=p.startsWith(f),s=p.includes(f),l=i.includes(f);return b||s||l});console.log(`[FeeCollection] Filtered ${h.length} students from ${t.length} with query "${m}"`),y(h)};n.useEffect(()=>{if(S){console.log("[FeeCollection] Debounced effect skipped - loading students");return}if(g.length===0){console.log("[FeeCollection] Debounced effect skipped - no students available"),c.trim()||y([]);return}console.log(`[FeeCollection] Debounced effect triggered - allStudents: ${g.length}, searchQuery: "${c}"`);const t=setTimeout(()=>{!S&&g.length>0?(console.log(`[FeeCollection] Debounced effect executing - filtering ${g.length} students`),W(g,c)):console.log("[FeeCollection] Debounced effect cancelled - loading or no students")},150);return()=>clearTimeout(t)},[c,g,S]);const T=t=>{R(t),$(!0)};return e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"flex justify-between items-center",children:e.jsx("h2",{className:"text-3xl font-bold",children:"Fee Collection"})}),e.jsxs("div",{className:"bg-white rounded-lg shadow-md p-6",children:[e.jsx("h3",{className:"text-xl font-semibold mb-4",children:"Search Student"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"Filter by Class (Optional)"}),e.jsxs("select",{value:x,onChange:t=>{const m=t.target.value,f=u.find(h=>h.id===m);console.log(`[FeeCollection] Class filter changed to: ${m} (${(f==null?void 0:f.name)||"unknown"})`),console.log("[FeeCollection] Available classes:",u.map(h=>({id:h.id,name:h.name}))),E(m),w(""),I([]),y([])},className:"w-full border border-gray-300 rounded-lg px-4 py-2",children:[e.jsx("option",{value:"",children:"All Classes"}),u.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"Search by Name"}),e.jsx("input",{type:"text",placeholder:x?`Search in ${((L=u.find(t=>t.id===x))==null?void 0:L.name)||"selected class"}...`:"Type student name (predictive search)...",value:c,onChange:t=>w(t.target.value),className:"w-full border border-gray-300 rounded-lg px-4 py-2"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:x?`Searching in ${((z=u.find(t=>t.id===x))==null?void 0:z.name)||"selected class"} - names starting with your input`:"Search shows students whose names start with your input"})]})]}),c&&e.jsx("div",{className:"border border-gray-200 rounded-lg max-h-64 overflow-y-auto",children:r.length===0?e.jsx("div",{className:"p-4 text-gray-500 text-center",children:c?e.jsxs("div",{children:[e.jsxs("p",{children:['No students found matching "',c,'"']}),x&&e.jsxs("p",{className:"text-xs mt-1",children:["in ",((q=u.find(t=>t.id===x))==null?void 0:q.name)||"selected class"]}),g.length>0&&e.jsxs("p",{className:"text-xs mt-1 text-gray-400",children:["Total students available: ",g.length]})]}):"Start typing to search for students"}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"p-2 bg-gray-50 text-xs text-gray-600 border-b",children:["Found ",r.length," student",r.length!==1?"s":"",' matching "',c,'"',x&&` in ${((Q=u.find(t=>t.id===x))==null?void 0:Q.name)||"selected class"}`]}),r.slice(0,50).map(t=>e.jsxs("div",{onClick:()=>T(t),className:`p-4 border-b border-gray-200 cursor-pointer hover:bg-gray-50 transition ${(j==null?void 0:j.id)===t.id?"bg-blue-50 border-blue-300":""}`,children:[e.jsx("div",{className:"font-semibold text-gray-900",children:t.name}),e.jsxs("div",{className:"text-sm text-gray-600",children:["Roll: ",t.roll_number," | Class: ",t.class]})]},t.id)),r.length>50&&e.jsx("div",{className:"p-4 text-center text-sm text-gray-500 bg-gray-50",children:"Showing first 50 results. Refine your search for more specific results."})]})}),!c&&x&&e.jsxs("div",{className:"border border-gray-200 rounded-lg max-h-64 overflow-y-auto",children:[e.jsxs("div",{className:"p-2 bg-gray-50 text-xs text-gray-600 border-b",children:["Showing ",r.length," of ",o||0," students in ",((D=u.find(t=>t.id===x))==null?void 0:D.name)||"selected class"]}),S?e.jsx("div",{className:"p-4 text-center text-gray-500",children:"Loading students..."}):r.length===0?e.jsx("div",{className:"p-4 text-center text-gray-500",children:"No students found in this class"}):r.slice(0,50).map(t=>e.jsxs("div",{onClick:()=>T(t),className:`p-4 border-b border-gray-200 cursor-pointer hover:bg-gray-50 transition ${(j==null?void 0:j.id)===t.id?"bg-blue-50 border-blue-300":""}`,children:[e.jsx("div",{className:"font-semibold text-gray-900",children:t.name}),e.jsxs("div",{className:"text-sm text-gray-600",children:["Roll: ",t.roll_number," | Class: ",t.class]})]},t.id))]}),!c&&!x&&e.jsx("div",{className:"border border-gray-200 rounded-lg max-h-64 overflow-y-auto",children:S?e.jsx("div",{className:"p-4 text-center text-gray-500",children:"Loading students..."}):r.length===0?e.jsx("div",{className:"p-4 text-center text-gray-500",children:g.length===0?e.jsxs("div",{children:[e.jsx("p",{children:"No students found. Please check:"}),e.jsxs("ul",{className:"text-xs mt-2 text-left list-disc list-inside space-y-1",children:[e.jsx("li",{children:"Are there active students in the system?"}),e.jsx("li",{children:"Is your authentication token valid?"}),e.jsx("li",{children:"Check browser console for API errors"})]})]}):e.jsxs("div",{children:[e.jsx("p",{children:"Start typing to search for students"}),e.jsx("p",{className:"text-xs mt-1 text-gray-400",children:"Or select a class to filter"})]})}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"p-2 bg-gray-50 text-xs text-gray-600 border-b",children:["Showing ",g.length," of ",o||0," students - Type to search or select a class to filter"]}),r.slice(0,50).map(t=>e.jsxs("div",{onClick:()=>T(t),className:`p-4 border-b border-gray-200 cursor-pointer hover:bg-gray-50 transition ${(j==null?void 0:j.id)===t.id?"bg-blue-50 border-blue-300":""}`,children:[e.jsx("div",{className:"font-semibold text-gray-900",children:t.name}),e.jsxs("div",{className:"text-sm text-gray-600",children:["Roll: ",t.roll_number," | Class: ",t.class]})]},t.id)),r.length>50&&e.jsx("div",{className:"p-4 text-center text-sm text-gray-500 bg-gray-50",children:"Showing first 50 students. Use search or class filter to narrow down results."})]})})]}),e.jsx(Z,{student:j,isOpen:_,onClose:()=>{$(!1),R(null)},onPaymentSuccess:()=>{U()}})]})}export{te as default};
