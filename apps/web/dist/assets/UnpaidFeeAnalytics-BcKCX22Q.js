import{r as c,f as R,j as e,g as P,P as T,h as A,C as M,T as $,i as D}from"./vendor-react-Bn_hPIu6.js";import{s as k,A as O}from"./index-HwjJ9f0_.js";import{R as B,a as V}from"./clerk.service-CDmFEBNd.js";const q=async({classId:p,timeScope:u,page:N=1,limit:f=20})=>{var m,h,j;const x=(m=(await k.auth.getSession()).data.session)==null?void 0:m.access_token;if(!x)throw new Error("Not authenticated");const g=new URLSearchParams({time_scope:u,page:N.toString(),limit:f.toString()});p&&g.append("class_group_id",p);const i=await fetch(`${O}${B.clerkFees}/analytics/unpaid?${g.toString()}`,{headers:{Authorization:`Bearer ${x}`}});if(!i.ok){const v=await i.json().catch(()=>({error:"Failed to load analytics"}));throw new Error(v.error||"Failed to load analytics")}const b=await i.json(),n=b.analytics||b;return n.pagination||(n.pagination={page:1,limit:((h=n.students)==null?void 0:h.length)||10,total:((j=n.students)==null?void 0:j.length)||0,total_pages:1}),n},S={paid:"#3B82F6",unpaid:"#EF4444",partially_paid:"#F59E0B"};function Y({userRole:p,onCollectFee:u}){const[N,f]=c.useState([]),[x,g]=c.useState(""),[i,b]=c.useState("last_month"),[n,m]=c.useState(1),[h]=c.useState(20),[j,v]=c.useState(new Set);c.useEffect(()=>{(async()=>{var l;try{const r=(l=(await k.auth.getSession()).data.session)==null?void 0:l.access_token;if(!r)return;const t=await V(r);f(t.classes||[]),t.classes&&t.classes.length>0&&!x&&g(t.classes[0].id)}catch(r){console.error("Error loading classes:",r)}})()},[]);const{data:a,isLoading:C,isFetching:F,error:_,isPlaceholderData:z}=R({queryKey:["unpaid-analytics",x||"all",i,n],queryFn:()=>q({classId:x||void 0,timeScope:i,page:n,limit:h}),placeholderData:s=>s,staleTime:2*60*1e3,enabled:!!i}),y=c.useMemo(()=>a!=null&&a.chart_data?[{name:"Paid",value:a.chart_data.paid,color:S.paid},{name:"Unpaid",value:a.chart_data.unpaid,color:S.unpaid},{name:"Partially Paid",value:a.chart_data.partially_paid,color:S.partially_paid}].filter(s=>s.value>0):[],[a]),E=()=>{if(!a||a.students.length===0){alert("No data to export");return}const s=["Student Name","Roll Number","Class","Parent Name","Parent Phone","Parent Address","Pending Months","Total Pending Amount"],l=a.students.map(d=>[d.student_name,d.roll_number,d.class_name,d.parent_name,d.parent_phone,d.parent_address,d.pending_months,d.total_pending.toFixed(2)]),r=[s.join(","),...l.map(d=>d.map(U=>`"${U}"`).join(","))].join(`
`),t=new Blob([r],{type:"text/csv"}),o=window.URL.createObjectURL(t),w=document.createElement("a");w.href=o,w.download=`unpaid_fees_${x||"all"}_${i}_${new Date().toISOString().split("T")[0]}.csv`,w.click(),window.URL.revokeObjectURL(o)},L=()=>{window.print()};return e.jsxs("div",{className:"bg-white rounded-lg shadow-md p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("h3",{className:"text-2xl font-bold",children:"Unpaid Fee Analytics"}),F&&!C&&e.jsx("div",{className:"inline-block animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600",title:"Refreshing..."})]}),p==="principal"&&a&&a.students.length>0&&e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:E,className:"px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm font-semibold",children:"Export CSV"}),e.jsx("button",{onClick:L,className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm font-semibold",children:"Export PDF"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-6",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"Select Class"}),e.jsxs("select",{value:x,onChange:s=>{g(s.target.value),m(1)},className:"w-full border border-gray-300 rounded-lg px-4 py-2",children:[e.jsx("option",{value:"",children:"All Classes"}),N.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"Time Scope"}),e.jsxs("select",{value:i,onChange:s=>{b(s.target.value),m(1)},className:"w-full border border-gray-300 rounded-lg px-4 py-2",children:[e.jsx("option",{value:"last_month",children:"Last Month"}),e.jsx("option",{value:"last_2_months",children:"Last 2 Months"}),e.jsx("option",{value:"last_3_months",children:"Last 3 Months"}),e.jsx("option",{value:"last_6_months",children:"Last 6 Months"}),e.jsx("option",{value:"current_academic_year",children:"Current Academic Year"})]})]})]}),C?e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 mb-6",children:[1,2,3,4].map(s=>e.jsxs("div",{className:"bg-gray-100 border border-gray-200 rounded-lg p-4 animate-pulse",children:[e.jsx("div",{className:"h-4 bg-gray-300 rounded w-24 mb-2"}),e.jsx("div",{className:"h-8 bg-gray-300 rounded w-16"})]},s))}),e.jsxs("div",{className:"text-center py-12",children:[e.jsx("div",{className:"inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mb-4"}),e.jsx("div",{className:"text-gray-500",children:"Loading analytics..."})]})]}):_?e.jsxs("div",{className:"text-center py-12",children:[e.jsx("div",{className:"text-red-600 font-semibold mb-2",children:"Error loading analytics"}),e.jsx("div",{className:"text-sm text-gray-500",children:_ instanceof Error?_.message:"Unknown error"})]}):a?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 mb-6",children:[e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:[e.jsx("div",{className:"text-sm text-blue-600 font-medium",children:"Total Students"}),e.jsx("div",{className:"text-2xl font-bold text-blue-900",children:a.summary.total_students})]}),e.jsxs("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4",children:[e.jsx("div",{className:"text-sm text-red-600 font-medium",children:"Unpaid"}),e.jsx("div",{className:"text-2xl font-bold text-red-900",children:a.summary.unpaid_count})]}),e.jsxs("div",{className:"bg-yellow-50 border border-yellow-200 rounded-lg p-4",children:[e.jsx("div",{className:"text-sm text-yellow-600 font-medium",children:"Partially Paid"}),e.jsx("div",{className:"text-2xl font-bold text-yellow-900",children:a.summary.partially_paid_count})]}),e.jsxs("div",{className:"bg-gray-50 border border-gray-200 rounded-lg p-4",children:[e.jsx("div",{className:"text-sm text-gray-600 font-medium",children:"Total Unpaid Amount"}),e.jsxs("div",{className:"text-2xl font-bold text-gray-900",children:["₹",a.summary.total_unpaid_amount.toFixed(2)]})]})]}),y.length>0&&e.jsxs("div",{className:"mb-6",children:[e.jsx("h4",{className:"text-lg font-semibold mb-4",children:"Payment Status Distribution"}),e.jsx("div",{className:"bg-gray-50 rounded-lg p-4",style:{height:"300px"},children:P?e.jsx(P,{width:"100%",height:"100%",children:e.jsxs(T,{children:[e.jsx(A,{data:y,cx:"50%",cy:"50%",labelLine:!1,label:({name:s,percent:l})=>`${s}: ${(l*100).toFixed(0)}%`,outerRadius:100,fill:"#8884d8",dataKey:"value",children:y.map((s,l)=>e.jsx(M,{fill:s.color},`cell-${l}`))}),e.jsx($,{}),e.jsx(D,{})]})}):e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-gray-500 mb-2",children:"Chart library not installed"}),e.jsx("p",{className:"text-sm text-gray-400",children:"Run: npm install recharts"}),e.jsx("div",{className:"mt-4 flex justify-center gap-4",children:y.map((s,l)=>e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"w-16 h-16 rounded-full mx-auto mb-2",style:{backgroundColor:s.color}}),e.jsx("div",{className:"text-sm font-semibold",children:s.name}),e.jsx("div",{className:"text-xs text-gray-600",children:s.value})]},l))})]})})})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-lg font-semibold mb-4",children:"Unpaid Students List"}),a.students.length===0?e.jsx("div",{className:"text-center py-8 text-gray-500",children:"No unpaid students found for the selected filters."}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full bg-white border border-gray-200 rounded-lg",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase border-b",children:"Student Name"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase border-b",children:"Roll Number"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase border-b",children:"Parent Name"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase border-b",children:"Phone"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase border-b",children:"Address"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase border-b",children:"Pending Months"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase border-b",children:"Total Pending"}),e.jsx("th",{className:"px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase border-b",children:"Action"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200",children:a.students.map(s=>{const l=j.has(s.student_id),r=s.fee_component_breakdown&&s.fee_component_breakdown.length>0;return e.jsxs(c.Fragment,{children:[e.jsxs("tr",{className:"hover:bg-gray-50 cursor-pointer",onClick:()=>{r&&v(t=>{const o=new Set(t);return o.has(s.student_id)?o.delete(s.student_id):o.add(s.student_id),o})},children:[e.jsx("td",{className:"px-4 py-3 text-sm font-medium",children:e.jsxs("div",{className:"flex items-center gap-2",children:[r&&e.jsx("span",{className:"text-gray-400",children:l?"▼":"▶"}),s.student_name]})}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-600",children:s.roll_number}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-600",children:s.parent_name}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-600",children:s.parent_phone}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-600",children:s.parent_address||"N/A"}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-600",children:s.pending_months}),e.jsxs("td",{className:"px-4 py-3 text-sm font-semibold text-red-600",children:["₹",s.total_pending.toFixed(2)]}),e.jsx("td",{className:"px-4 py-3 text-center",onClick:t=>t.stopPropagation(),children:p==="clerk"&&u?e.jsx("button",{onClick:()=>u(s.student_id),className:"px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm font-semibold",children:"Collect Fee"}):e.jsx("span",{className:"text-sm text-gray-500",children:"View Only"})})]}),l&&r&&e.jsx("tr",{children:e.jsx("td",{colSpan:8,className:"px-4 py-4 bg-gray-50",children:e.jsxs("div",{className:"ml-6",children:[e.jsx("h5",{className:"text-sm font-semibold text-gray-700 mb-3",children:"Fee Component Breakdown"}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:s.fee_component_breakdown.map((t,o)=>e.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg p-4",children:[e.jsx("div",{className:"font-semibold text-gray-900 mb-3",children:t.fee_name}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between mb-1",children:[e.jsx("span",{className:"text-gray-600",children:"Total Months Due:"}),e.jsx("span",{className:"font-medium",children:t.total_months_due})]}),t.total_months_due_names&&t.total_months_due_names.length>0&&e.jsx("div",{className:"text-xs text-gray-500 pl-2",children:t.total_months_due_names.join(", ")})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between mb-1",children:[e.jsx("span",{className:"text-gray-600",children:"Paid Months:"}),e.jsx("span",{className:"font-medium text-green-600",children:t.paid_months})]}),t.paid_months_names&&t.paid_months_names.length>0&&e.jsx("div",{className:"text-xs text-green-600 pl-2",children:t.paid_months_names.join(", ")})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between mb-1",children:[e.jsx("span",{className:"text-gray-600",children:"Pending Months:"}),e.jsx("span",{className:"font-medium text-red-600",children:t.pending_months})]}),t.pending_months_names&&t.pending_months_names.length>0&&e.jsx("div",{className:"text-xs text-red-600 pl-2",children:t.pending_months_names.join(", ")})]}),e.jsxs("div",{className:"border-t border-gray-200 pt-2 mt-2",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Total Fee:"}),e.jsxs("span",{className:"font-medium",children:["₹",t.total_fee_amount.toFixed(2)]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Total Paid:"}),e.jsxs("span",{className:"font-medium text-green-600",children:["₹",t.total_paid_amount.toFixed(2)]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Total Pending:"}),e.jsxs("span",{className:"font-medium text-red-600",children:["₹",t.total_pending_amount.toFixed(2)]})]})]})]})]},o))})]})})})]},s.student_id)})})]})}),a.pagination.total_pages>1&&e.jsxs("div",{className:"flex justify-between items-center mt-4",children:[e.jsxs("div",{className:"text-sm text-gray-600",children:["Showing ",(n-1)*h+1," to ",Math.min(n*h,a.pagination.total)," of ",a.pagination.total," students"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>m(s=>Math.max(1,s-1)),disabled:n===1,className:"px-4 py-2 border border-gray-300 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-50",children:"Previous"}),e.jsx("button",{onClick:()=>m(s=>Math.min(a.pagination.total_pages,s+1)),disabled:n===a.pagination.total_pages,className:"px-4 py-2 border border-gray-300 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-50",children:"Next"})]})]})]})]})]}):e.jsx("div",{className:"text-center py-12 text-gray-500",children:"Select a class and time scope to view analytics"})]})}export{Y as U};
