import{r as n,s as Y,j as e}from"./index-B92PX25p.js";import{b as ce,c as me,d as xe,a as ue,e as he}from"./clerk.service-BZBxP7KQ.js";function ge({student:l,isOpen:_,onClose:f,onPaymentSuccess:z}){var k,A,V,Q,ee,te,se,ae,ne,le,re,oe,ie,de;const[x,T]=n.useState(null),[u,q]=n.useState([]),[p,W]=n.useState(!1),[c,E]=n.useState([]),[F,G]=n.useState("class-fee"),[M,P]=n.useState(!1),[r,v]=n.useState({payment_amount:"",payment_date:new Date().toISOString().split("T")[0],payment_mode:"cash",transaction_id:"",cheque_number:"",bank_name:"",notes:""}),[$,L]=n.useState(!1),[o,J]=n.useState(null),[K,X]=n.useState(!1),[B,R]=n.useState(!1),[I,U]=n.useState([]),[Z,O]=n.useState(!1);n.useEffect(()=>{_&&l?s(l.id):(T(null),q([]),E([]),P(!1),R(!1))},[_,l]),n.useEffect(()=>{const t=i=>{i.key==="Escape"&&_&&f()};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[_,f]);const s=async t=>{var i;W(!0);try{const a=(i=(await Y.auth.getSession()).data.session)==null?void 0:i.access_token;if(!a)return;try{const d=await ce(a,t);d.message&&d.message==="No fee configured for this student"?(T(null),q([])):(T(d.fee_structure),q(d.monthly_ledger||[]))}catch(d){d.message&&d.message.includes("No fee configured")?(T(null),q([])):console.error("Error loading fee data:",d)}}catch(a){console.error("Error loading fee data:",a)}finally{W(!1)}},b=async()=>{var t;if(l){O(!0);try{const i=(t=(await Y.auth.getSession()).data.session)==null?void 0:t.access_token;if(!i)return;const a=await me(i,l.id);U(a.payments||[]),R(!0)}catch(i){console.error("Error loading payment history:",i)}finally{O(!1)}}},N=(t,i)=>{const a=new Date,d=a.getFullYear(),C=a.getMonth()+1;return t>d||t===d&&i>C},j=n.useCallback((t,i,a)=>{if(N(i,a)){alert("Cannot select future months for payment. Advance payments require Principal approval.");return}E(d=>d.includes(t)?d.filter(g=>g!==t):[...d,t])},[]),w=n.useMemo(()=>c.length===0?[]:u.flatMap(t=>t.components||[]).filter(t=>c.includes(t.id)),[c,u]),y=n.useMemo(()=>w.reduce((t,i)=>t+i.pending_amount,0),[w]);n.useEffect(()=>{M&&c.length>0&&y>0?v(t=>({...t,payment_amount:y.toFixed(2)})):M&&c.length===0&&v(t=>({...t,payment_amount:""}))},[M,c,y]);const h=async t=>{var C;if(t.preventDefault(),c.length===0){alert("Please select at least one fee component");return}if(!l)return;const a=u.flatMap(g=>g.components||[]).filter(g=>c.includes(g.id)).reduce((g,D)=>g+D.pending_amount,0),d=parseFloat(r.payment_amount||"0");if(d<=0){alert("Payment amount must be greater than 0");return}if(d>a){alert(`Payment amount (â‚¹${d.toFixed(2)}) cannot exceed total pending (â‚¹${a.toFixed(2)})`);return}L(!0);try{const g=(C=(await Y.auth.getSession()).data.session)==null?void 0:C.access_token;if(!g){alert("Authentication required");return}const D={monthly_fee_component_ids:c,payment_amount:d,payment_date:r.payment_date,payment_mode:r.payment_mode,transaction_id:r.transaction_id||void 0,cheque_number:r.cheque_number||void 0,bank_name:r.bank_name||void 0,notes:r.notes||void 0},H=await xe(g,D);J(H),X(!0),P(!1),E([]),await s(l.id),z&&z()}catch(g){alert(g.message||"Failed to process payment")}finally{L(!1)}},S=t=>{switch(t){case"paid":return"bg-green-100 text-green-800";case"partially-paid":return"bg-yellow-100 text-yellow-800";case"overdue":return"bg-red-100 text-red-800";default:return"bg-gray-100 text-gray-800"}},m=n.useMemo(()=>u.flatMap(t=>t.components||[]).reduce((t,i)=>t+i.pending_amount,0),[u]);return!_||!l?null:e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 bg-black/40 z-40 transition-opacity",onClick:f}),e.jsxs("div",{className:`fixed top-0 right-0 h-full w-[460px] bg-white shadow-2xl z-50 transform transition-transform duration-300 ease-in-out ${_?"translate-x-0":"translate-x-full"} flex flex-col`,children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b bg-gray-50",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("h2",{className:"text-xl font-bold text-gray-900",children:l.name}),e.jsxs("div",{className:"text-sm text-gray-600 mt-1",children:["Roll: ",l.roll_number," | Class: ",l.class]}),m>0&&e.jsx("div",{className:"mt-2",children:e.jsxs("span",{className:"inline-flex items-center px-3 py-1 rounded-full text-sm font-semibold bg-red-100 text-red-800",children:["Total Pending: â‚¹",m.toFixed(2)]})})]}),e.jsx("button",{onClick:f,className:"ml-4 text-gray-500 hover:text-gray-700 text-2xl font-bold leading-none","aria-label":"Close drawer",children:"Ã—"})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-6",children:p?e.jsx("div",{className:"text-center py-8 text-gray-500",children:"Loading fee data..."}):x===null?e.jsxs("div",{className:"bg-yellow-50 border border-yellow-200 rounded-lg p-6 text-center",children:[e.jsx("p",{className:"text-yellow-800 font-semibold text-lg",children:"âš ï¸ No fee configured for this student"}),e.jsx("p",{className:"text-yellow-700 mt-2",children:"Please contact Principal to assign fee structure."})]}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:[e.jsx("h4",{className:"font-semibold mb-3",children:"Assigned Fee Structure"}),e.jsxs("div",{className:"grid grid-cols-1 gap-4 text-sm",children:[(x==null?void 0:x.class_fee)&&e.jsxs("div",{className:"bg-white rounded p-3",children:[e.jsx("div",{className:"font-semibold text-blue-700",children:"Class Fee"}),e.jsxs("div",{children:["â‚¹",x.class_fee.amount.toFixed(2)]}),e.jsx("div",{className:"text-xs text-gray-600",children:x.class_fee.billing_frequency})]}),(x==null?void 0:x.transport_fee)&&e.jsxs("div",{className:"bg-white rounded p-3",children:[e.jsx("div",{className:"font-semibold text-blue-700",children:"Transport Fee"}),e.jsxs("div",{children:["â‚¹",x.transport_fee.amount.toFixed(2)]}),e.jsxs("div",{className:"text-xs text-gray-600",children:[x.transport_fee.route_name," | ",x.transport_fee.billing_frequency]})]}),(x==null?void 0:x.custom_fees)&&x.custom_fees.length>0&&e.jsxs("div",{className:"bg-white rounded p-3",children:[e.jsxs("div",{className:"font-semibold text-blue-700",children:["Custom Fees (",x.custom_fees.length,")"]}),x.custom_fees.map((t,i)=>e.jsxs("div",{className:"text-xs",children:[t.category_name,": â‚¹",t.amount.toFixed(2)," (",t.billing_frequency,")"]},i))]})]})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold mb-3",children:"Monthly Fee Status Ledger"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full bg-white border border-gray-200 rounded-lg text-xs",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase border-b",children:"Month"}),e.jsx("th",{className:"px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase border-b",children:"Fee"}),e.jsx("th",{className:"px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase border-b",children:"Amount"}),e.jsx("th",{className:"px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase border-b",children:"Paid"}),e.jsx("th",{className:"px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase border-b",children:"Pending"}),e.jsx("th",{className:"px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase border-b",children:"Status"}),e.jsx("th",{className:"px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase border-b",children:"âœ“"})]})}),e.jsxs("tbody",{className:"divide-y divide-gray-200",children:[u.map((t,i)=>(t.components||[]).map((a,d)=>{const C=a.status==="overdue"||a.due_date&&new Date(a.due_date)<new Date&&a.status!=="paid",g=N(t.year||0,t.monthNumber||0),D=a.status==="paid"||a.pending_amount===0||g,H=a.status==="paid"?"bg-green-50":C?"bg-red-50":a.status==="partially-paid"?"bg-yellow-50":"bg-white";return e.jsxs("tr",{className:`${H} ${C?"border-l-4 border-red-500":""} ${g?"opacity-60":""}`,children:[e.jsx("td",{className:"px-2 py-2 text-xs font-medium text-gray-900",children:d===0?t.month:""}),e.jsxs("td",{className:"px-2 py-2 text-xs text-gray-700",children:[e.jsx("div",{className:"font-medium",children:a.fee_name}),e.jsx("div",{className:"text-xs text-gray-500 capitalize",children:a.fee_type.replace("-"," ")})]}),e.jsxs("td",{className:"px-2 py-2 text-xs text-gray-700",children:["â‚¹",a.fee_amount.toFixed(2)]}),e.jsx("td",{className:"px-2 py-2 text-xs text-gray-700",children:e.jsxs("span",{className:a.paid_amount>0?"text-green-600 font-semibold":"",children:["â‚¹",a.paid_amount.toFixed(2)]})}),e.jsx("td",{className:"px-2 py-2 text-xs text-gray-700",children:e.jsxs("span",{className:a.pending_amount>0?"text-red-600 font-semibold":"text-gray-500",children:["â‚¹",a.pending_amount.toFixed(2)]})}),e.jsx("td",{className:"px-2 py-2 text-xs",children:e.jsx("span",{className:`px-2 py-1 rounded-full text-xs font-semibold ${S(a.status)}`,children:a.status==="paid"?"ğŸŸ¢":C?"ğŸ”´":a.status==="partially-paid"?"ğŸŸ¡":g?"ğŸ”µ":"âšª"})}),e.jsx("td",{className:"px-2 py-2 text-center",children:e.jsx("input",{type:"checkbox",checked:c.includes(a.id),onChange:()=>j(a.id,t.year||0,t.monthNumber||0),disabled:D,title:g?"Future months require Principal approval":a.status==="paid"?"Already paid":a.pending_amount===0?"No pending amount":"",className:"w-4 h-4 cursor-pointer disabled:cursor-not-allowed"})})]},`${i}-${d}`)})),u.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:7,className:"px-4 py-8 text-center text-gray-500",children:"No fee data available for this student"})})]})]})}),e.jsxs("div",{className:"mt-4 flex flex-wrap gap-4 text-xs",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 bg-green-100 border border-green-300 rounded"}),e.jsx("span",{children:"Paid"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 bg-yellow-100 border border-yellow-300 rounded"}),e.jsx("span",{children:"Partially Paid"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 bg-red-100 border border-red-300 rounded"}),e.jsx("span",{children:"Pending/Overdue"})]})]})]})]})}),e.jsxs("div",{className:"border-t p-4 bg-gray-50 flex gap-2",children:[e.jsx("button",{onClick:b,className:"flex-1 px-4 py-2 rounded-lg font-semibold bg-green-600 text-white hover:bg-green-700 text-sm",children:"View History"}),e.jsxs("button",{onClick:()=>{P(!0),G("class-fee")},disabled:c.length===0,className:`flex-1 px-4 py-2 rounded-lg font-semibold text-sm ${c.length===0?"bg-gray-300 text-gray-500 cursor-not-allowed":"bg-blue-600 text-white hover:bg-blue-700"}`,children:["Collect (",c.length,")"]})]})]}),M&&l&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60] p-4",children:e.jsxs("div",{className:"bg-white rounded-lg w-full max-w-2xl max-h-[90vh] overflow-y-auto",children:[e.jsxs("div",{className:"flex justify-between items-center p-6 border-b bg-gray-50",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-2xl font-bold",children:"Collect Fee"}),e.jsxs("p",{className:"text-sm text-gray-600 mt-1",children:[l.name," Â· ",l.class]})]}),e.jsx("button",{onClick:()=>{P(!1),E([])},className:"text-gray-500 hover:text-gray-700 text-2xl font-bold",children:"Ã—"})]}),e.jsx("div",{className:"p-6",children:c.length===0?e.jsx("div",{className:"text-center py-8 text-gray-500",children:"Please select fee components from the ledger table above"}):e.jsx("form",{onSubmit:h,children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"Payment Mode *"}),e.jsxs("select",{value:r.payment_mode,onChange:t=>v({...r,payment_mode:t.target.value}),className:"w-full border border-gray-300 rounded-lg px-3 py-2",required:!0,children:[e.jsx("option",{value:"cash",children:"Cash"}),e.jsx("option",{value:"upi",children:"UPI"}),e.jsx("option",{value:"online",children:"Online"}),e.jsx("option",{value:"card",children:"Card"}),e.jsx("option",{value:"cheque",children:"Cheque"}),e.jsx("option",{value:"bank_transfer",children:"Bank Transfer"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"Payment Amount *"}),e.jsx("input",{type:"number",step:"0.01",min:"0",max:y,value:r.payment_amount||(c.length>0?y.toFixed(2):""),onChange:t=>v({...r,payment_amount:t.target.value}),className:"w-full border border-gray-300 rounded-lg px-3 py-2",required:!0}),e.jsxs("p",{className:"text-xs mt-1 text-gray-500",children:["Max: â‚¹",y.toFixed(2)," (Total Pending)"]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"Payment Date *"}),e.jsx("input",{type:"date",value:r.payment_date,onChange:t=>v({...r,payment_date:t.target.value}),className:"w-full border border-gray-300 rounded-lg px-3 py-2",required:!0})]}),(r.payment_mode==="upi"||r.payment_mode==="online"||r.payment_mode==="card")&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"Transaction ID"}),e.jsx("input",{type:"text",value:r.transaction_id,onChange:t=>v({...r,transaction_id:t.target.value}),className:"w-full border border-gray-300 rounded-lg px-3 py-2",placeholder:"Enter transaction ID"})]}),r.payment_mode==="cheque"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"Cheque Number"}),e.jsx("input",{type:"text",value:r.cheque_number,onChange:t=>v({...r,cheque_number:t.target.value}),className:"w-full border border-gray-300 rounded-lg px-3 py-2",placeholder:"Enter cheque number"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"Bank Name"}),e.jsx("input",{type:"text",value:r.bank_name,onChange:t=>v({...r,bank_name:t.target.value}),className:"w-full border border-gray-300 rounded-lg px-3 py-2",placeholder:"Enter bank name"})]})]}),r.payment_mode==="bank_transfer"&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"Bank Name"}),e.jsx("input",{type:"text",value:r.bank_name,onChange:t=>v({...r,bank_name:t.target.value}),className:"w-full border border-gray-300 rounded-lg px-3 py-2",placeholder:"Enter bank name"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"Notes (Optional)"}),e.jsx("textarea",{value:r.notes,onChange:t=>v({...r,notes:t.target.value}),className:"w-full border border-gray-300 rounded-lg px-3 py-2",rows:2,placeholder:"Additional notes..."})]}),e.jsxs("div",{className:"flex justify-between items-center pt-4 border-t",children:[e.jsx("button",{type:"button",onClick:()=>{P(!1),E([])},className:"px-6 py-2 text-gray-700 hover:text-gray-900 font-medium",children:"Cancel"}),e.jsx("button",{type:"submit",disabled:$||c.length===0,className:"px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed font-semibold",children:$?"Processing...":"Save & Print Receipt"})]})]})})})]})}),B&&l&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60] p-4",children:e.jsxs("div",{className:"bg-white rounded-lg w-full max-w-4xl max-h-[90vh] overflow-y-auto",children:[e.jsxs("div",{className:"flex justify-between items-center p-6 border-b",children:[e.jsxs("h3",{className:"text-2xl font-bold",children:["Payment History - ",l.name]}),e.jsx("button",{onClick:()=>{R(!1),U([])},className:"px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300",children:"Close"})]}),e.jsx("div",{className:"p-6",children:Z?e.jsx("div",{className:"text-center py-8",children:"Loading payment history..."}):I.length===0?e.jsx("div",{className:"text-center py-8 text-gray-500",children:"No payment records found"}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full bg-white border border-gray-200 rounded-lg",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase border-b",children:"Date"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase border-b",children:"Fee Component"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase border-b",children:"Period"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase border-b",children:"Amount"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase border-b",children:"Mode"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase border-b",children:"Receipt No"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase border-b",children:"Collected By"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200",children:I.map((t,i)=>{var a,d,C,g,D,H;return e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"px-4 py-3 text-sm",children:new Date(t.payment_date).toLocaleDateString()}),e.jsxs("td",{className:"px-4 py-3 text-sm",children:[e.jsx("div",{className:"font-medium",children:((a=t.monthly_fee_components)==null?void 0:a.fee_name)||"N/A"}),e.jsx("div",{className:"text-xs text-gray-500 capitalize",children:((C=(d=t.monthly_fee_components)==null?void 0:d.fee_type)==null?void 0:C.replace("-"," "))||""})]}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-600",children:(g=t.monthly_fee_components)!=null&&g.period_month&&((D=t.monthly_fee_components)!=null&&D.period_year)?`${new Date(2e3,t.monthly_fee_components.period_month-1).toLocaleString("default",{month:"short"})} ${t.monthly_fee_components.period_year}`:"N/A"}),e.jsxs("td",{className:"px-4 py-3 text-sm font-semibold text-green-600",children:["â‚¹",parseFloat(t.payment_amount||0).toFixed(2)]}),e.jsx("td",{className:"px-4 py-3 text-sm uppercase text-gray-600",children:t.payment_mode}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-600",children:t.receipt_number||"N/A"}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-600",children:((H=t.received_by_profile)==null?void 0:H.full_name)||"Clerk"})]},i)})}),e.jsx("tfoot",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("td",{colSpan:3,className:"px-4 py-3 text-sm font-semibold text-right",children:"Total Payments:"}),e.jsxs("td",{className:"px-4 py-3 text-sm font-bold text-green-600",children:["â‚¹",I.reduce((t,i)=>t+parseFloat(i.payment_amount||0),0).toFixed(2)]}),e.jsx("td",{colSpan:3})]})})]})})})]})}),K&&o&&l&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60]",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-2xl w-full max-h-[90vh] overflow-y-auto",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-2xl font-bold",children:"Payment Receipt"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>{window.print()},className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700",children:"Print"}),e.jsx("button",{onClick:()=>{X(!1),J(null)},className:"px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300",children:"Close"})]})]}),e.jsxs("div",{className:"border-2 border-gray-300 rounded-lg p-8 space-y-6 print:border-0",children:[e.jsxs("div",{className:"text-center border-b-2 border-gray-400 pb-4",children:[e.jsx("h4",{className:"text-3xl font-bold mb-2",children:"FEE PAYMENT RECEIPT"}),e.jsxs("div",{className:"space-y-1 text-gray-700",children:[e.jsxs("p",{className:"font-semibold",children:["Receipt No: ",o.receipt_number||((k=o.payment)==null?void 0:k.receipt_number)]}),e.jsxs("p",{children:["Date: ",new Date(((A=o.payment)==null?void 0:A.payment_date)||o.payment_date||new Date).toLocaleDateString("en-IN",{weekday:"long",year:"numeric",month:"long",day:"numeric"})]})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold text-gray-700 mb-1",children:"Student Name:"}),e.jsx("div",{className:"text-lg",children:l.name})]}),e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold text-gray-700 mb-1",children:"Roll Number:"}),e.jsx("div",{className:"text-lg",children:l.roll_number})]}),e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold text-gray-700 mb-1",children:"Class:"}),e.jsx("div",{className:"text-lg",children:l.class})]}),e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold text-gray-700 mb-1",children:"Payment Mode:"}),e.jsx("div",{className:"text-lg uppercase",children:((V=o.payment)==null?void 0:V.payment_mode)||"CASH"})]})]}),e.jsxs("div",{className:"border-t border-b border-gray-300 py-4",children:[e.jsx("h5",{className:"font-semibold mb-3 text-gray-700",children:"Payment Details:"}),e.jsx("div",{className:"space-y-2",children:(o.selectedComponents||w).map((t,i)=>e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-gray-600",children:t.fee_name}),e.jsxs("span",{className:"font-semibold",children:["â‚¹",t.pending_amount.toFixed(2)]})]},i))})]}),(((Q=o.payment)==null?void 0:Q.transaction_id)||((ee=o.payment)==null?void 0:ee.cheque_number)||((te=o.payment)==null?void 0:te.bank_name))&&e.jsxs("div",{className:"border-b border-gray-300 pb-4",children:[e.jsx("h5",{className:"font-semibold mb-2 text-gray-700",children:"Transaction Details:"}),((se=o.payment)==null?void 0:se.transaction_id)&&e.jsxs("div",{className:"text-sm",children:["Transaction ID: ",o.payment.transaction_id]}),((ae=o.payment)==null?void 0:ae.cheque_number)&&e.jsxs("div",{className:"text-sm",children:["Cheque Number: ",o.payment.cheque_number]}),((ne=o.payment)==null?void 0:ne.bank_name)&&e.jsxs("div",{className:"text-sm",children:["Bank: ",o.payment.bank_name]})]}),e.jsx("div",{className:"border-t-2 border-gray-400 pt-4",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-xl font-semibold",children:"Total Amount Paid:"}),e.jsxs("span",{className:"text-2xl font-bold text-blue-600",children:["â‚¹",((re=(le=o.payment)==null?void 0:le.amount_paid)==null?void 0:re.toFixed(2))||((ie=(oe=o.payment)==null?void 0:oe.payment_amount)==null?void 0:ie.toFixed(2))||(typeof o.payment_amount=="number"?o.payment_amount.toFixed(2):"0.00")]})]})}),((de=o.payment)==null?void 0:de.notes)&&e.jsxs("div",{className:"bg-gray-50 p-3 rounded-lg",children:[e.jsx("div",{className:"font-semibold text-sm text-gray-700 mb-1",children:"Notes:"}),e.jsx("div",{className:"text-sm text-gray-600",children:o.payment.notes})]}),o.message&&e.jsxs("div",{className:"bg-blue-50 border border-blue-200 p-3 rounded-lg text-sm text-blue-800",children:[e.jsx("div",{className:"font-semibold mb-1",children:"Note:"}),o.message]}),e.jsxs("div",{className:"border-t border-gray-300 pt-4 mt-8 text-center text-xs text-gray-500",children:[e.jsx("p",{children:"This is a computer-generated receipt."}),e.jsx("p",{className:"mt-2",children:"Collected by: Clerk"})]})]})]})})]})}function ye(){var R,I,U,Z,O;const[l,_]=n.useState([]),[f,z]=n.useState([]),[x,T]=n.useState(0),[u,q]=n.useState(""),[p,W]=n.useState(""),[c,E]=n.useState([]),[F,G]=n.useState(null),[M,P]=n.useState(!1),[r,v]=n.useState(!1),[$,L]=n.useState(!1),o=n.useRef(0);n.useEffect(()=>{J()},[]),n.useEffect(()=>{K()},[p]);const J=async()=>{var s;v(!0);try{const b=(s=(await Y.auth.getSession()).data.session)==null?void 0:s.access_token;if(!b)return;const j=(await ue(b)).classes||[];console.log("[FeeCollection] Loaded classes:",j.map(w=>({id:w.id,name:w.name}))),E(j)}catch(b){console.error("Error loading classes:",b)}finally{v(!1)}},K=async()=>{var b,N,j,w;const s=++o.current;L(!0);try{const y=(b=(await Y.auth.getSession()).data.session)==null?void 0:b.access_token;if(!y){L(!1);return}const h=await he(y,p||void 0,1,50);if(s!==o.current){console.log("[FeeCollection] Ignoring stale request result"),L(!1);return}console.log("[FeeCollection] Received data:",{classesCount:((N=h.classes)==null?void 0:N.length)||0,unassignedCount:((j=h.unassigned)==null?void 0:j.length)||0,selectedClass:p,searchQuery:u,total_students:h.total_students,pagination:h.pagination,fullResponse:h});let S=[];if(h.classes&&Array.isArray(h.classes)?(console.log(`[FeeCollection] Processing ${h.classes.length} classes`),h.classes.forEach(m=>{var k;console.log(`[FeeCollection] Processing class: ${m.name} (id: ${m.id}), students: ${((k=m.students)==null?void 0:k.length)||0}`),m.students&&Array.isArray(m.students)?(console.log(`[FeeCollection] Class ${m.name} has ${m.students.length} students`),m.students.forEach(A=>{var Q;const V=((Q=A.profile)==null?void 0:Q.full_name)||"Unknown";console.log(`[FeeCollection] Adding student: ${V} (id: ${A.id}, roll: ${A.roll_number})`),S.push({id:A.id,name:V,roll_number:A.roll_number||"N/A",class:m.name||"N/A",class_group_id:m.id})})):console.warn(`[FeeCollection] Class ${m.name} has no students array or it's not an array:`,m)})):console.warn("[FeeCollection] No classes array in response or it's not an array:",h.classes),!p&&h.unassigned&&Array.isArray(h.unassigned)&&h.unassigned.forEach(m=>{var k;S.push({id:m.id,name:((k=m.profile)==null?void 0:k.full_name)||"Unknown",roll_number:m.roll_number||"N/A",class:"Unassigned",class_group_id:void 0})}),console.log(`[FeeCollection] Extracted ${S.length} students from response`),s===o.current){z(S);const m=h.total_students||((w=h.pagination)==null?void 0:w.total)||0;T(m),console.log(`[FeeCollection] Updated allStudents with ${S.length} students (total from API: ${m})`),u.trim()||(console.log(`[FeeCollection] No search query, setting ${S.length} students immediately`),_(S))}}catch(y){if(console.error("Error loading students:",y),f.length===0&&l.length===0){const h=(y==null?void 0:y.message)||"Failed to load students";console.error("[FeeCollection] API Error:",h)}}finally{s===o.current&&L(!1)}},X=(s,b)=>{if(!b.trim()){console.log(`[FeeCollection] No search query, setting all ${s.length} students`),_(s);return}const N=b.toLowerCase().trim(),j=s.filter(w=>{const y=(w.name||"").toLowerCase(),h=(w.roll_number||"").toLowerCase(),S=y.startsWith(N),m=y.includes(N),k=h.includes(N);return S||m||k});console.log(`[FeeCollection] Filtered ${j.length} students from ${s.length} with query "${b}"`),_(j)};n.useEffect(()=>{if($){console.log("[FeeCollection] Debounced effect skipped - loading students");return}if(f.length===0){console.log("[FeeCollection] Debounced effect skipped - no students available"),u.trim()||_([]);return}console.log(`[FeeCollection] Debounced effect triggered - allStudents: ${f.length}, searchQuery: "${u}"`);const s=setTimeout(()=>{!$&&f.length>0?(console.log(`[FeeCollection] Debounced effect executing - filtering ${f.length} students`),X(f,u)):console.log("[FeeCollection] Debounced effect cancelled - loading or no students")},150);return()=>clearTimeout(s)},[u,f,$]);const B=s=>{G(s),P(!0)};return e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"flex justify-between items-center",children:e.jsx("h2",{className:"text-3xl font-bold",children:"Fee Collection"})}),e.jsxs("div",{className:"bg-white rounded-lg shadow-md p-6",children:[e.jsx("h3",{className:"text-xl font-semibold mb-4",children:"Search Student"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"Filter by Class (Optional)"}),e.jsxs("select",{value:p,onChange:s=>{const b=s.target.value,N=c.find(j=>j.id===b);console.log(`[FeeCollection] Class filter changed to: ${b} (${(N==null?void 0:N.name)||"unknown"})`),console.log("[FeeCollection] Available classes:",c.map(j=>({id:j.id,name:j.name}))),W(b),q(""),z([]),_([])},className:"w-full border border-gray-300 rounded-lg px-4 py-2",children:[e.jsx("option",{value:"",children:"All Classes"}),c.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"Search by Name"}),e.jsx("input",{type:"text",placeholder:p?`Search in ${((R=c.find(s=>s.id===p))==null?void 0:R.name)||"selected class"}...`:"Type student name (predictive search)...",value:u,onChange:s=>q(s.target.value),className:"w-full border border-gray-300 rounded-lg px-4 py-2"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:p?`Searching in ${((I=c.find(s=>s.id===p))==null?void 0:I.name)||"selected class"} - names starting with your input`:"Search shows students whose names start with your input"})]})]}),u&&e.jsx("div",{className:"border border-gray-200 rounded-lg max-h-64 overflow-y-auto",children:l.length===0?e.jsx("div",{className:"p-4 text-gray-500 text-center",children:u?e.jsxs("div",{children:[e.jsxs("p",{children:['No students found matching "',u,'"']}),p&&e.jsxs("p",{className:"text-xs mt-1",children:["in ",((U=c.find(s=>s.id===p))==null?void 0:U.name)||"selected class"]}),f.length>0&&e.jsxs("p",{className:"text-xs mt-1 text-gray-400",children:["Total students available: ",f.length]})]}):"Start typing to search for students"}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"p-2 bg-gray-50 text-xs text-gray-600 border-b",children:["Found ",l.length," student",l.length!==1?"s":"",' matching "',u,'"',p&&` in ${((Z=c.find(s=>s.id===p))==null?void 0:Z.name)||"selected class"}`]}),l.slice(0,50).map(s=>e.jsxs("div",{onClick:()=>B(s),className:`p-4 border-b border-gray-200 cursor-pointer hover:bg-gray-50 transition ${(F==null?void 0:F.id)===s.id?"bg-blue-50 border-blue-300":""}`,children:[e.jsx("div",{className:"font-semibold text-gray-900",children:s.name}),e.jsxs("div",{className:"text-sm text-gray-600",children:["Roll: ",s.roll_number," | Class: ",s.class]})]},s.id)),l.length>50&&e.jsx("div",{className:"p-4 text-center text-sm text-gray-500 bg-gray-50",children:"Showing first 50 results. Refine your search for more specific results."})]})}),!u&&p&&e.jsxs("div",{className:"border border-gray-200 rounded-lg max-h-64 overflow-y-auto",children:[e.jsxs("div",{className:"p-2 bg-gray-50 text-xs text-gray-600 border-b",children:["Showing ",l.length," of ",x||0," students in ",((O=c.find(s=>s.id===p))==null?void 0:O.name)||"selected class"]}),$?e.jsx("div",{className:"p-4 text-center text-gray-500",children:"Loading students..."}):l.length===0?e.jsx("div",{className:"p-4 text-center text-gray-500",children:"No students found in this class"}):l.slice(0,50).map(s=>e.jsxs("div",{onClick:()=>B(s),className:`p-4 border-b border-gray-200 cursor-pointer hover:bg-gray-50 transition ${(F==null?void 0:F.id)===s.id?"bg-blue-50 border-blue-300":""}`,children:[e.jsx("div",{className:"font-semibold text-gray-900",children:s.name}),e.jsxs("div",{className:"text-sm text-gray-600",children:["Roll: ",s.roll_number," | Class: ",s.class]})]},s.id))]}),!u&&!p&&e.jsx("div",{className:"border border-gray-200 rounded-lg max-h-64 overflow-y-auto",children:$?e.jsx("div",{className:"p-4 text-center text-gray-500",children:"Loading students..."}):l.length===0?e.jsx("div",{className:"p-4 text-center text-gray-500",children:f.length===0?e.jsxs("div",{children:[e.jsx("p",{children:"No students found. Please check:"}),e.jsxs("ul",{className:"text-xs mt-2 text-left list-disc list-inside space-y-1",children:[e.jsx("li",{children:"Are there active students in the system?"}),e.jsx("li",{children:"Is your authentication token valid?"}),e.jsx("li",{children:"Check browser console for API errors"})]})]}):e.jsxs("div",{children:[e.jsx("p",{children:"Start typing to search for students"}),e.jsx("p",{className:"text-xs mt-1 text-gray-400",children:"Or select a class to filter"})]})}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"p-2 bg-gray-50 text-xs text-gray-600 border-b",children:["Showing ",f.length," of ",x||0," students - Type to search or select a class to filter"]}),l.slice(0,50).map(s=>e.jsxs("div",{onClick:()=>B(s),className:`p-4 border-b border-gray-200 cursor-pointer hover:bg-gray-50 transition ${(F==null?void 0:F.id)===s.id?"bg-blue-50 border-blue-300":""}`,children:[e.jsx("div",{className:"font-semibold text-gray-900",children:s.name}),e.jsxs("div",{className:"text-sm text-gray-600",children:["Roll: ",s.roll_number," | Class: ",s.class]})]},s.id)),l.length>50&&e.jsx("div",{className:"p-4 text-center text-sm text-gray-500 bg-gray-50",children:"Showing first 50 students. Use search or class filter to narrow down results."})]})})]}),e.jsx(ge,{student:F,isOpen:M,onClose:()=>{P(!1),G(null)},onPaymentSuccess:()=>{K()}})]})}export{ye as default};
